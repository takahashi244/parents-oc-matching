# 診断ロジック改善案 v0.1

## 目的
- プレゼンに耐えるだけの「おすすめ理由の説得力」と「行動を後押しする情報」を提供する。
- 興味／科目／憧れ人物を元にしたシナリオを明文化し、OC情報と合わせてスコアと理由を構成。

## 現状の課題
- タグ一致の上限が2件で差が出にくい。
- 科目マッピングが粗く、細分科目が活きない。
- ヒーロー入力がフリーテキストのため、タグ連動が弱い。
- 理由文が定型で「なぜこの学校か」が伝わりにくい。
- OCが無い学科の理由が薄い。

## 改善方針
- Q1〜Q3の入力を構造化し、スコアリングと理由生成を同じデータで行う。
- 興味カテゴリ別にプリセット化したジャンル・人物から選択→タグへマッピング。
- OC情報は日程＋形式＋地域で評価し、「行動しやすさ」情報を理由へ組み込み。

## 入力構造
### Q1 興味カテゴリ
- 例: 音楽 / 漫画・アニメ / 映像メディア / スポーツ / 医療・看護 / 国際 / 起業・ビジネス / テクノロジー / 教育・心理 / 自然・科学 など。
- 各カテゴリに代表ジャンル選択肢を用意（複数選択可）。
- 選択肢ごとに以下を定義する:
  - `display_name`: UI表示
  - `tags`: 付与するタグ配列
  - `reason_template`: 理由文のテンプレート例

例: 音楽カテゴリ
- J-POP (tags: ["music"], reason: "最新のJ-POP制作環境が整っている")
- ライブ演奏 (tags: ["music", "media"], reason: "ライブ収録や音響の学びが深い")
- 作曲・DTM (tags: ["music", "programming"], reason: "作曲ソフトやDTMカリキュラムが充実")

例: アニメ・マンガカテゴリ
- キャラクターデザイン (tags: ["design_art"], ...)
- アニメーション制作 (tags: ["media", "design_art"], ...)
- 漫画ストーリー制作 (tags: ["design_art", "history_social"], ...)

※ 各カテゴリで3〜5個の代表選択肢を用意し、ユーザーは複数選択可。自由入力は補足コメントとして扱う。

### Q2 科目
- 既存の教科＋細分化科目を「科目カテゴリ」へ整理し、タグとの関連度を重みづけ:
  - 数学 → `math_data` (重み6), `programming` (重み4)
  - 物理 → `science` (重み6), `programming` (重み2)
  - 世界史 → `history_social` (重み6), `english_global` (重み2)
  - 英語 → `english_global` (重み7)
  - 美術 → `design_art` (重み6), `media` (重み3)
  - 音楽 → `music` (重み7)
  - 体育 → `sports` (重み7), `medical` (重み2)
- 複数科目選択時は各タグへ重みを加算。タグの合計点に上限を設定（例: コアタグは最大15点）。

### Q3 ヒーロー（尊敬人物）
- カテゴリ選択式（複数可）:
  - 起業家 / デザイナー / エンジニア / 研究者 / アーティスト / 医療従事者 / 教育者 / ジャーナリスト / クリエイター など。
- カテゴリごとにタグ付与。例: 起業家→`business`, `math_data`; 研究者→`science`; アーティスト→`music`, `design_art`。
- 自由記述欄は補足コメントとして保存し、理由文に「〇〇さんの言葉に共感」などを追記。

### OCイベント
- 入力項目: 日付, 形式(対面/オンライン/ハイブリッド), 開催地, 予約リンク。
- スコア要素:
  1. 日程が近いほど高得点 (30日以内 +5 / 60日以内 +3 / 90日以内 +1)。
  2. ユーザーの居住地域（診断の想定入力）と開催地が同じ都道府県なら +2。
  3. オンライン開催なら「参加しやすさ」として +2。

## スコア計算フロー
1. 空の `tagScores[tag] = 0` マップを用意。
2. Q1 で選んだジャンルの `tags` を、それぞれ baseWeight(=8) で加点。
3. Q2 の科目ごとに関連タグへ重み加算。
4. Q3 のヒーローカテゴリで 5〜8点加算。
5. タグごとに上限値を 0〜20 にクリップ。
6. タグスコアの上位N個を候補学科のマッチ判定に利用。

学科スコア = Σ(タグ一致 * タグスコア) + OCスコア。
- タグ一致: 学科のタグリストに含まれる場合、タグスコア（例: `tagScores[tag]`）。
- OCスコア: 該当学科のOCから算出した +0〜9 の値。

## 理由生成
- 上位タグから理由テンプレートを選択（例: "プログラミング" → "AIやソフト開発に強みがある"）。
- 科目理由: 「好き科目: 数学」を選んだ場合 `math_data` に紐付く説明を挿入。
- ヒーロー理由: 選択カテゴリに応じた文（"エンジニアに憧れている" → "最先端の開発環境を学べる"）。
- OC理由: 日付＋形式＋開催地から「〇/〇 (土) オンライン開催で参加しやすい」。
- 最低3件、推奨4〜5件の理由を、カテゴリ（学び・進路・行動）を意識して構成。

## データ調整
- `config/match_preferences.php` といった設定ファイルを新設し、カテゴリ/タグ/理由文テンプレートを定義。
- CSVは実在校向けに更新。タグは実際のカリキュラムに合わせて精査。
- Seederは `truncateWithForeignKeys` メソッドを追加し、`InitSeeder` から使用。

## UI調整ポイント
- Q1 パネル: カテゴリ毎にカード表示＋代表選択肢（チェックボックス）＋自由入力テキスト。
- Q2: 科目はチェックボックス＋細分科目をトグル表示。
- Q3: ヒーローカテゴリはチップ風の複数選択＋自由入力。
- 理由表示: `match-results.blade.php` のカードを拡張し、タグバッジ＋理由リスト＋OC情報を視覚化。

## 実装ステップ
1. 設定ファイル（カテゴリ定義）を追加。
2. マッチングロジックを新しいスコア計算に差し替え。
3. 理由テンプレートを Blade で反映。
4. OCスコアと理由を生成するヘルパを追加。
5. UI/フォームの入力方式を更新。
6. Seeder と CSV の整備、`migrate:fresh --seed` で検証。

## 次アクション
- この案へのフィードバックを受けて、カテゴリ/重み/理由テンプレートを確定。
- 確定後にコード差分を作成し、フロントUI含めて改修。
